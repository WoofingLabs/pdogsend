<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WPGA 本地双击必跑 1秒版</title>
<style>
    body{background:#000;color:#0f0;font-family:consolas;margin:0;padding:20px;}
    input,button{width:100%;padding:15px;margin:12px 0;background:#111;border:1px solid #0f0;border-radius:8px;color:#0f0;font-size:18px;}
    button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
    #status{color:#0f0;font-size:22px;text-align:center;margin:20px 0;}
    #log{height:320px;overflow:auto;background:#000;padding:10px;border:1px solid #0f0;border-radius:8px;font-size:14px;}
    .run{animation:flash 1s infinite;}@keyframes flash{0%,100%{opacity:1}50%{opacity:0.4}}
</style>
</head>
<body>
<h1 style="text-align:center">WPGA 本地双击必跑版</h1>
<input type="password" id="pk" placeholder="私钥（带0x）">
<input type="text" id="gp" placeholder="Gas Price Gwei（留空自动）">
<input type="text" id="gl" value="10000000" placeholder="Gas Limit">
<button id="start">启动1秒监控（这次真能点）</button>
<button id="stop" style="display:none;background:#f00;">停止监控</button>
<div id="status">等待启动...</div>
<div id="log"></div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
<script>
const web3 = new Web3("https://pgpnode.pgachain.org");
const WPGA = "0x1369a5f999618607bB0bb92892Ef69e2233F88f8";
const TARGET = "0xC1A34Cca87f79125718714C56e8Ee59EAA195FEE";
const FACTORY = "0x0f7AEBDA3E4b70493Bc7b10E77299E4A0eF8681";
const BUY_CONTRACT = "0x165BD68cB3027Ca8fc0F5302cA427192121049aB";

const factory = new web3.eth.Contract([{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"getPair","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}], FACTORY);
const token = new web3.eth.Contract([{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}], WPGA);

let running = false;

function log(msg){
    const t = new Date().toLocaleTimeString();
    document.getElementById('log').innerHTML += `<div>${t} → ${msg}</div>`;
    document.getElementById('log').scrollTop = 1e9;
}

async function check(){
    if(!running) return;

    try{
        const pair = await factory.methods.getPair(WPGA, TARGET).call();
        if(pair === "0x0000000000000000000000000000000000000000"){
            document.getElementById('status').innerHTML = '<span class="run">1秒狂刷中... 未加池</span>';
            log("未检测到交易对，继续监控");
        }else{
            const b = await token.methods.balanceOf(pair).call();
            const amt = Number(web3.utils.fromWei(b,'ether')).toFixed(2);
            document.getElementById('status').innerHTML = `<span class="run">池子 ${amt} WPGA</span>`;
            log(`当前池子 ${amt} WPGA`);

            if(Number(amt) >= 10000){
                log("触发！池子≥10000，立即全仓买入！");
                document.getElementById('status').textContent = "正在全仓打币...";
                running = false;
                document.getElementById('start').style.display = "block";
                document.getElementById('stop').style.display = "none";
                await snipe();
                return;
            }
        }
    }catch(e){
        document.getElementById('status').innerHTML = '<span class="run">节点稍卡，继续1秒狂刷</span>';
    }

    setTimeout(check, 1000);  // 核心：用 setTimeout 递归，永不被卡
}

async function snipe(){
    const pk = document.getElementById('pk').value.trim();
    if(!pk) return log("私钥为空");

    const acc = web3.eth.accounts.privateKeyToAccount(pk);
    web3.eth.accounts.wallet.add(acc);

    const bal = await web3.eth.getBalance(acc.address);
    const send = (BigInt(bal) - BigInt(web3.utils.toWei("0.5","ether"))).toString();

    let gp = await web3.eth.getGasPrice();
    if(document.getElementById('gp').value) gp = web3.utils.toWei(document.getElementById('gp').value,'gwei');

    try{
        log(`全仓打 ${web3.utils.fromWei(send,'ether')} PGA（留0.5Gas）`);
        const tx = await web3.eth.accounts.signTransaction({
            to: BUY_CONTRACT,
            value: send,
            gas: Number(document.getElementById('gl').value || 10000000),
            gasPrice: gp
        }, pk);

        const r = await web3.eth.sendSignedTransaction(tx.rawTransaction);
        log("狙击成功！！！");
        log("交易: https://pgp.elastos.io/tx/"+r.transactionHash);
        document.getElementById('status').textContent = "狙击成功！";
    }catch(e){
        log("失败: "+e.message);
        document.getElementById('status').textContent = "狙击失败";
    }
}

document.getElementById('start').onclick = ()=>{
    if(!document.getElementById('pk').value.trim()){
        alert("先填私钥！");
        return;
    }
    running = true;
    document.getElementById('start').style.display = "none";
    document.getElementById('stop').style.display = "block";
    document.getElementById('status').innerHTML = '<span class="run">1秒监控已启动！</span>';
    log("1秒监控正式启动");
    check();
};

document.getElementById('stop').onclick = ()=>{
    running = false;
    document.getElementById('start').style.display = "block";
    document.getElementById('stop').style.display = "none";
    document.getElementById('status').textContent = "已停止";
    log("监控已手动停止");
};
</script>
</body>
</html>
