<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PGA 一键购买</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Changa+One&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00ff41',     // 亮绿
                        dark: '#070808',
                        'light-gray': '#E5E7EB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Changa One', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark text-white font-sans overflow-x-hidden min-h-screen">

    <section class="min-h-screen pt-20 pb-16 flex items-center justify-center px-4">
        <div class="container mx-auto max-w-md">
            <div class="text-center mb-10">
                <h1 class="font-display text-6xl text-primary">PGA BUY</h1>
                <p class="text-light-gray mt-3 text-lg">用 PGA 一键购买任意代币（滑点 5%）</p>
            </div>

            <div class="bg-dark/60 p-8 rounded-2xl border border-primary/40 space-y-6">

                <button id="connectWalletButton" class="w-full py-4 bg-primary text-black rounded-full font-bold text-lg hover:opacity-90 transition">
                    连接钱包
                </button>

                <div id="userInfo" class="hidden space-y-4 text-sm">
                    <div class="flex justify-between"><span class="text-light-gray">钱包地址:</span> 
                        <span id="address" class="font-mono text-primary">未连接</span>
                    </div>
                    <div class="flex justify-between"><span class="text-light-gray">PGA 余额:</span> 
                        <span id="balance" class="font-mono">0</span>
                    </div>
                    <button id="allBtn" class="w-full py-3 bg-white/10 rounded-xl hover:bg-white/20 transition text-sm">
                        全部购买（保留 0.1 PGA 给 Gas）
                    </button>
                </div>

                <div>
                    <label class="block text-left text-light-gray mb-2">目标代币地址</label>
                    <input id="token" type="text" placeholder="例如: 0x1369a5f999618607bB0bb92892Ef69e2233F88f8" 
                           class="w-full px-5 py-4 bg-dark/80 border border-primary/30 rounded-xl text-white focus:outline-none focus:border-primary" />
                </div>

                <div>
                    <label class="block text-left text-light-gray mb-2">购买金额（PGA）</label>
                    <input id="amount" type="text" placeholder="输入数量" 
                           class="w-full px-5 py-4 bg-dark/80 border border-primary/30 rounded-xl text-white focus:outline-none focus:border-primary" />
                </div>

                <button id="buyButton" class="w-full py-5 bg-primary text-black rounded-full font-bold text-xl hover:opacity-90 transition disabled:opacity-50" disabled>
                    一键购买
                </button>

                <p id="status" class="text-center text-sm min-h-6 text-light-gray">请先连接钱包</p>
            </div>

            <div class="mt-8 text-center text-xs text-light-gray space-y-1">
                <div>合约: 0xc571eBf5c6A5AC3ff28097D1170f78CE11793cf5</div>
                <div>路由: 0x3F67bDFB5003723e70bf18C7F6239814a2437bA8</div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script>
        const CONTRACT = "0xc571eBf5c6A5AC3ff28097D1170f78CE11793cf5";
        const ABI = [{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"buy","outputs":[],"stateMutability":"payable","type":"function"}];

        let web3, account, contract;

        const connectButton = document.getElementById('connectWalletButton');
        const buyButton     = document.getElementById('buyButton');
        const allBtn        = document.getElementById('allBtn');
        const status        = document.getElementById('status');

        // 自动切换到 PGP Chain（Chain ID 860621）
        async function switchToPGP() {
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '860621' }],    // 直接写十进制
                });
            } catch (error) {
                if (error.code === 4902) {  // 没添加过网络
                    await ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '860621',
                            chainName: 'PGP Chain',
                            rpcUrls: ['https://pgpnode.pgachain.org'],
                            nativeCurrency: { name: 'PGA', symbol: 'PGA', decimals: 18 },
                            blockExplorerUrls: ['https://pgp.elastos.io']
                        }]
                    });
                } else {
                    throw error;
               に戻
            }
        }

        connectButton.onclick = async () => {
            if (!window.ethereum) return status.textContent = '请安装 MetaMask';

            try {
                await switchToPGP();
                await ethereum.request({ method: 'eth_requestAccounts' });
                web3 = new Web3(ethereum);
                account = (await web3.eth.getAccounts())[0];
                contract = new web3.eth.Contract(ABI, CONTRACT);

                connectButton.innerHTML = `已连接 ${account.slice(0,6)}...${account.slice(-4)}`;
                connectButton.disabled = true;
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('address').textContent = account;
                buyButton.disabled = false;

                await updateBalance();
                setInterval(updateBalance, 8000);
                status.textContent = '连接成功，可一键购买任意代币';
            } catch (err) {
                status.textContent = '连接失败，请确保已添加 PGP Chain (860621)';
            }
        };

        async function updateBalance() {
            if (!account) return;
            const bal = await web3.eth.getBalance(account);
            document.getElementById('balance').textContent = Number(web3.utils.fromWei(bal, 'ether')).toFixed(4) + ' PGA';
        }

        allBtn.onclick = async () => {
            const bal = await web3.eth.getBalance(account);
            const keep = web3.utils.toWei('0.1', 'ether');
            const send = BigInt(bal) - BigInt(keep);
            if (send <= 0) {
                status.textContent = '余额不足 0.1 PGA';
                return;
            }
            const amount = web3.utils.fromWei(send.toString(), 'ether');
            document.getElementById('amount').value = Number(amount).toFixed(6).replace(/\.?0+$/,'');
            status.textContent = '已填最大金额（保留 0.1 PGA 给 Gas）';
        };

        buyButton.onclick = async () => {
            const token = document.getElementById('token').value.trim();
            const amountStr = document.getElementById('amount').value.trim();

            if (!web3.utils.isAddress(token)) return status.textContent = '代币地址错误';
            if (!amountStr || isNaN(amountStr) || Number(amountStr) <= 0) return status.textContent = '请输入正确金额';

            const value = web3.utils.toWei(amountStr, 'ether');

            buyButton.innerHTML = '购买中...';
            buyButton.disabled = true;
            status.textContent = '请在钱包确认交易...';

            try {
                const tx = await contract.methods.buy(token).send({ from: account, value: value });
                status.innerHTML = `购买成功！<br><a href="https://pgp.elastos.io/tx/${tx.transactionHash}" target="_blank" class="underline text-primary">查看交易</a>`;
                await updateBalance();
            } catch (err) {
                status.textContent = err.message.includes('User denied') ? '已取消交易' : '购买失败：' + err.message.split('(')[0];
            } finally {
                buyButton.innerHTML = '一键购买';
                buyButton.disabled = false;
            }
        };
    </script>
</body>
</html>
